name: Maintain bounds

on:
  workflow_call:
    inputs:
      command:
        required: true
        type: string
      timeout:
        required: false
        type: number
        default: 3600
      options:
        required: false
        type: string
        default: ''
      cachix:
        required: false
        type: string
        default: tek
    secrets:
      cachix_key:
        required: false

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  lower:
    name: Check and update ${{ startsWith(inputs.command, 'lower') && 'lower' || 'upper' }} bounds
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: |
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    - uses: DeterminateSystems/magic-nix-cache-action@main
    - uses: cachix/cachix-action@v15
      with:
        name: ${{ inputs.cachix }}
        signingKey: ${{ secrets.cachix_key }}
    - id: bounds
      name: Check and update bounds
      run: nix run .#${{ inputs.command }} -- --output=ga-pr --build-timeout=${{ inputs.timeout }} ${{ inputs.options }}
    - name: Create pull request
      if: steps.bounds.outputs.commit-message
      uses: peter-evans/create-pull-request@v6
      with: ${{ steps.bounds.outputs }}
